apiVersion: batch/v1
kind: Job
metadata:
  name: ssok-transfer-service-discord-notification
  namespace: ssok
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
    argocd.argoproj.io/sync-wave: "10"  # ëª¨ë“  ë°°í¬ ì™„ë£Œ í›„
spec:
  template:
    spec:
      containers:
      - name: discord-notify
        image: curlimages/curl:latest
        env:
        - name: WEBHOOK_URL
          valueFrom:
            secretKeyRef:
              name: ssok-transfer-service-discord-webhook
              key: webhook-url
        command:
        - sh
        - -c
        - |
          DEPLOY_TIME=$(date "+%Y-%m-%d %H:%M:%S")
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"embeds\": [{
                   \"title\": \"âœ… {{ .Values.notification.profile }} ssok-transfer-service ë°°í¬ ì„±ê³µ\",
                   \"description\": \"ëª¨ë“  ì»´í¬ë„ŒíŠ¸ê°€ ì •ìƒì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.\",
                   \"color\": 65280,
                   \"fields\": [
                     {
                       \"name\": \"ğŸ¦ ì• í”Œë¦¬ì¼€ì´ì…˜\",
                       \"value\": \"ssok-transfer-service\",
                       \"inline\": true
                     },
                     {
                       \"name\": \"ğŸ“¦ ë„¤ì„ìŠ¤í˜ì´ìŠ¤\",
                       \"value\": \"ssok\", 
                       \"inline\": true
                     },
                     {
                       \"name\": \"â° ë°°í¬ ì‹œê°„\",
                       \"value\": \"$DEPLOY_TIME\",
                       \"inline\": false
                     }
                   ],
                   \"footer\": {
                     \"text\": \"ArgoCD PostSync Hook\"
                   }
                 }]
               }" \
               "$WEBHOOK_URL"
      restartPolicy: Never
      serviceAccountName: default  # kubectl ê¶Œí•œ í•„ìš” ì‹œ ë³„ë„ ServiceAccount ìƒì„±
---
apiVersion: batch/v1
kind: Job
metadata:
  name: ssok-transfer-service-discord-failure-notification
  namespace: ssok
  annotations:
    argocd.argoproj.io/hook: SyncFail
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
    argocd.argoproj.io/sync-wave: "10"  # ëª¨ë“  ë°°í¬ ì™„ë£Œ í›„
spec:
  template:
    spec:
      containers:
      - name: discord-notify
        image: curlimages/curl:latest
        env:
        - name: WEBHOOK_URL
          valueFrom:
            secretKeyRef:
              name: ssok-transfer-service-discord-webhook
              key: webhook-url
        command:
        - sh
        - -c
        - |
          DEPLOY_TIME=$(date "+%Y-%m-%d %H:%M:%S")
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"embeds\": [{
                   \"title\": \"âŒ ssok-transfer-service ë°°í¬ ì‹¤íŒ¨\",
                   \"description\": \"ssok-transfer-service ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\",
                   \"color\": 16711680,
                   \"fields\": [
                     {
                       \"name\": \"ğŸ¦ ì• í”Œë¦¬ì¼€ì´ì…˜\",
                       \"value\": \"ssok-transfer-service\",
                       \"inline\": true
                     },
                     {
                       \"name\": \"ğŸ“¦ ë„¤ì„ìŠ¤í˜ì´ìŠ¤\",
                       \"value\": \"ssok\", 
                       \"inline\": true
                     },
                     {
                       \"name\": \"â° ì‹œê°„\",
                       \"value\": \"$DEPLOY_TIME\",
                       \"inline\": false
                     }
                   ]
                 }]
               }" \
               "$WEBHOOK_URL"
      restartPolicy: Never
---
apiVersion: v1
kind: Secret
metadata:
  name: ssok-transfer-service-discord-webhook
  namespace: ssok
type: Opaque
stringData:
  webhook-url: {{ index .Values.notification "webhook-url" }}