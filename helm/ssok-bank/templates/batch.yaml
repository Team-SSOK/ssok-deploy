apiVersion: batch/v1
kind: Job
metadata:
  name: ssok-bank-discord-notification
  namespace: bank
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
    argocd.argoproj.io/sync-wave: "10"  # ëª¨ë“  ë°°í¬ ì™„ë£Œ í›„
spec:
  template:
    spec:
      containers:
      - name: discord-notify
        image: curlimages/curl:latest
        env:
        - name: WEBHOOK_URL
          valueFrom:
            secretKeyRef:
              name: ssok-bank-discord-webhook
              key: webhook-url
        command:
        - sh
        - -c
        - |
          TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{
                 "embeds": [{
                   "title": "âœ… ssok-bank ë°°í¬ ì„±ê³µ",
                   "description": "ëª¨ë“  ì»´í¬ë„ŒíŠ¸ê°€ ì •ìƒì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.",
                   "color": 65280,
                   "fields": [
                     {
                       "name": "ğŸ¦ ì• í”Œë¦¬ì¼€ì´ì…˜",
                       "value": "ssok-bank",
                       "inline": true
                     },
                     {
                       "name": "ğŸ“¦ ë„¤ì„ìŠ¤í˜ì´ìŠ¤",
                       "value": "bank", 
                       "inline": true
                     },
                     {
                       "name": "â° ë°°í¬ ì‹œê°„",
                       "value": "${TIMESTAMP}",
                       "inline": false
                     }
                   ],
                   "footer": {
                     "text": "ArgoCD PostSync Hook"
                   }
                 }]
               }' \
               "$WEBHOOK_URL"
      restartPolicy: Never
      serviceAccountName: default  # kubectl ê¶Œí•œ í•„ìš” ì‹œ ë³„ë„ ServiceAccount ìƒì„±
---
apiVersion: batch/v1
kind: Job
metadata:
  name: ssok-bank-discord-failure-notification
  namespace: bank
  annotations:
    argocd.argoproj.io/hook: SyncFail
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
    argocd.argoproj.io/sync-wave: "10"  # ëª¨ë“  ë°°í¬ ì™„ë£Œ í›„
spec:
  template:
    spec:
      containers:
      - name: discord-notify
        image: curlimages/curl:latest
        env:
        - name: WEBHOOK_URL
          valueFrom:
            secretKeyRef:
              name: ssok-bank-discord-webhook
              key: webhook-url
        command:
        - sh
        - -c
        - |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{
                 "embeds": [{
                   "title": "âŒ ë°°í¬ ì‹¤íŒ¨",
                   "description": "ssok-bank ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
                   "color": 16711680,
                   "fields": [
                     {
                       "name": "ğŸ¦ ì• í”Œë¦¬ì¼€ì´ì…˜",
                       "value": "ssok-bank",
                       "inline": true
                     },
                     {
                       "name": "â° ì‹œê°„",
                       "value": "'$(date +'%Y-%m-%d %H:%M:%S')'",
                       "inline": true
                     }
                   ]
                 }]
               }' \
               "$WEBHOOK_URL"
      restartPolicy: Never
---
apiVersion: v1
kind: Secret
metadata:
  name: ssok-bank-discord-webhook
  namespace: bank
type: Opaque
stringData:
  webhook-url: "https://discord.com/api/webhooks/1377886188312068146/eFtja7Ax7h84bD9z5CZhm7jligL1wDIRRLvQgr-UnxnACEUSkyI4Gm9NsenVFwnwKnLK"