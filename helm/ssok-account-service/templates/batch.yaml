apiVersion: batch/v1
kind: Job
metadata:
  name: ssok-account-service-discord-notification
  namespace: ssok
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
    argocd.argoproj.io/sync-wave: "10"  # ëª¨ë“  ë°°í¬ ì™„ë£Œ í›„
spec:
  template:
    spec:
      containers:
      - name: discord-notify
        image: curlimages/curl:latest
        env:
        - name: WEBHOOK_URL
          valueFrom:
            secretKeyRef:
              name: ssok-account-service-discord-webhook
              key: webhook-url
        - name: SSOM_URL
          valueFrom:
            secretKeyRef:
              name: ssok-account-service-discord-webhook
              key: ssom-url
        command:
        - sh
        - -c
        - |
          UTC_TIMESTAMP=$(date -u +%s)
          KST_TIMESTAMP=$((UTC_TIMESTAMP + 32400))
          DEPLOY_TIME=$(date -u -d @$KST_TIMESTAMP "+%Y-%m-%dT%H:%M:%S")
          DEPLOY_TIME_DISPLAY=$(echo "$DEPLOY_TIME" | sed 's/T/ /')
          curl --connect-timeout 2 --fail -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"embeds\": [{
                   \"title\": \"âœ… {{ .Values.notification.profile }} ssok-account-service ë°°í¬ ì„±ê³µ\",
                   \"description\": \"ëª¨ë“  ì»´í¬ë„ŒíŠ¸ê°€ ì •ìƒì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.\",
                   \"color\": 65280,
                   \"fields\": [
                     {
                       \"name\": \"ğŸ¦ ì• í”Œë¦¬ì¼€ì´ì…˜\",
                       \"value\": \"ssok-account-service\",
                       \"inline\": true
                     },
                     {
                       \"name\": \"ğŸ“¦ ë„¤ì„ìŠ¤í˜ì´ìŠ¤\",
                       \"value\": \"ssok\", 
                       \"inline\": true
                     },
                     {
                       \"name\": \"â° ë°°í¬ ì‹œê°„\",
                       \"value\": \"$DEPLOY_TIME_DISPLAY\",
                       \"inline\": false
                     }
                   ],
                   \"footer\": {
                     \"text\": \"ArgoCD PostSync Hook\"
                   }
                 }]
               }" \
               "$WEBHOOK_URL"
          curl --connect-timeout 2 --fail -X POST \
              -H "Content-Type: application/json" \
              -d "{
                \"level\": \"INFO\",
                \"app\": \"argocd_ssok-account-service\",
                \"timestamp\": \"$DEPLOY_TIME\",
                \"message\": \"ArgoCD ssok-account-service ë°°í¬ ì„±ê³µ - ëª¨ë“  ì»´í¬ë„ŒíŠ¸ê°€ ì •ìƒì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.\"
              }" \
              "$SSOM_URL" || true               
      restartPolicy: Never
      serviceAccountName: default  # kubectl ê¶Œí•œ í•„ìš” ì‹œ ë³„ë„ ServiceAccount ìƒì„±
---
apiVersion: batch/v1
kind: Job
metadata:
  name: ssok-account-service-discord-failure-notification
  namespace: ssok
  annotations:
    argocd.argoproj.io/hook: SyncFail
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
    argocd.argoproj.io/sync-wave: "10"  # ëª¨ë“  ë°°í¬ ì™„ë£Œ í›„
spec:
  template:
    spec:
      containers:
      - name: discord-notify
        image: curlimages/curl:latest
        env:
        - name: WEBHOOK_URL
          valueFrom:
            secretKeyRef:
              name: ssok-account-service-discord-webhook
              key: webhook-url
        - name: SSOM_URL
          valueFrom:
            secretKeyRef:
              name: ssok-account-service-discord-webhook
              key: ssom-url              
        command:
        - sh
        - -c
        - |
          apk add --no-cache tzdata
          export TZ=Asia/Seoul
          DEPLOY_TIME=$(date "+%Y-%m-%dT%H:%M:%S")
          DEPLOY_TIME_DISPLAY=$(echo "$DEPLOY_TIME" | sed 's/T/ /')
          curl --connect-timeout 2 --fail -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"embeds\": [{
                   \"title\": \"âŒ {{ .Values.notification.profile }} ssok-account-service ë°°í¬ ì‹¤íŒ¨\",
                   \"description\": \"ssok-account-service ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\",
                   \"color\": 16711680,
                   \"fields\": [
                     {
                       \"name\": \"ğŸ¦ ì• í”Œë¦¬ì¼€ì´ì…˜\",
                       \"value\": \"ssok-account-service\",
                       \"inline\": true
                     },
                     {
                       \"name\": \"ğŸ“¦ ë„¤ì„ìŠ¤í˜ì´ìŠ¤\",
                       \"value\": \"ssok\", 
                       \"inline\": true
                     },
                     {
                       \"name\": \"â° ì‹œê°„\",
                       \"value\": \"$DEPLOY_TIME_DISPLAY\",
                       \"inline\": false
                     }
                   ]
                 }]
               }" \
               "$WEBHOOK_URL"
          curl --connect-timeout 2 --fail -X POST \
              -H "Content-Type: application/json" \
              -d "{
                \"level\": \"ERROR\",
                \"app\": \"argocd_ssok-account-service\",
                \"timestamp\": \"$DEPLOY_TIME\",
                \"message\": \"ArgoCD ssok-account-service ë°°í¬ ì‹¤íŒ¨ - ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\"
              }" \
              "$SSOM_URL" || true              
      restartPolicy: Never
---
apiVersion: v1
kind: Secret
metadata:
  name: ssok-account-service-discord-webhook
  namespace: ssok
type: Opaque
data:
  webhook-url: {{ index .Values.notification "webhook-url" }}
  ssom-url: {{ index .Values.notification "ssom-url" }}